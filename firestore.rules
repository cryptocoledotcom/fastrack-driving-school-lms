rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function getAuthUser() {
      return request.auth;
    }

    function isAuthenticated() {
      return getAuthUser() != null;
    }

    function userRole() {
      return request.auth.token.role != null ? request.auth.token.role : get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isStudent() {
      return userRole() == 'student';
    }

    function isInstructor() {
      return userRole() == 'instructor';
    }

    function isDmvAdmin() {
      return userRole() == 'dmv_admin';
    }

    function isSuperAdmin() {
      return userRole() == 'super_admin';
    }

    function isAdmin() {
      return isDmvAdmin() || isSuperAdmin();
    }

    function isOwnProfile(userId) {
      return getAuthUser().uid == userId;
    }

    function isInstructorForStudent(studentId) {
      return isInstructor() && get(/databases/$(database)/documents/users/$(studentId)).data.instructorId == getAuthUser().uid;
    }

    function canViewEnrollment(enrollmentData) {
      return isAdmin() || 
             (isOwnProfile(enrollmentData.userId)) ||
             (isInstructor() && isInstructorForStudent(enrollmentData.userId));
    }

    function canViewProgress(progressData) {
      return isAdmin() || 
             (isOwnProfile(progressData.userId)) ||
             (isInstructor() && isInstructorForStudent(progressData.userId));
    }

    function canViewQuizAttempt(attemptData) {
      return isAdmin() || 
             (isOwnProfile(attemptData.userId)) ||
             (isInstructor() && isInstructorForStudent(attemptData.userId));
    }

    function canViewCertificate(certData) {
      return isAdmin() || isOwnProfile(certData.userId);
    }

    function canViewIdentityVerification(verificationData) {
      return isAdmin() || isOwnProfile(verificationData.userId);
    }

    // --- User Profile Rules ---
    match /users/{userId} {
      allow read: if isOwnProfile(userId) || isAdmin();
      allow write: if isOwnProfile(userId);
      allow update: if isOwnProfile(userId) || isAdmin();
    }
    
    match /users/{userId}/{document=**} {
      allow read, write: if isOwnProfile(userId) || isAdmin();
    }

    // Compliance Sessions (user subcollection)
    match /users/{userId}/sessions/{sessionId} {
      allow read: if isOwnProfile(userId) || isAdmin();
      
      // SECURITY: Strict validation for break operations
      allow update: if isOwnProfile(userId) && 
        // Can only update breaks array
        request.resource.data.keys().hasOnly(['breaks']) &&
        // Validate each break in array
        request.resource.data.breaks.size() > 0 &&
        // Last break must have server-calculated actualDuration >= 600 seconds
        request.resource.data.breaks[request.resource.data.breaks.size() - 1].actualDuration >= 600 &&
        // Must have validation timestamp
        request.resource.data.breaks[request.resource.data.breaks.size() - 1].validatedByServer == true;
      
      allow delete: if false;
    }

    // Identity Verifications Subcollection
    match /users/{userId}/identityVerifications/{verificationId} {
      allow read, write: if isOwnProfile(userId) || isAdmin();
      allow delete: if false;
    }
    
    // --- Content Rules (Public Read) ---
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    match /modules/{moduleId} {
      allow read: if true;
      allow write: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    match /lessons/{lessonId} {
      allow read: if true;
      allow write: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // --- Admin Data Rules ---
    match /admin-data/{docId} {
      allow read, write: if isAdmin();
      allow delete: if false;
    }
    
    // --- Certificate Rules ---
    match /certificates/{certificateId} {
      allow read: if canViewCertificate(resource.data);
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false;
    }

    // --- Time Slots Rules ---
    match /timeSlots/{slotId} {
      allow read: if isInstructor() || isAdmin();
      allow write: if isAdmin();
      allow delete: if false;
    }

    // --- Bookings Rules ---
    match /bookings/{bookingId} {
      allow read: if isOwnProfile(resource.data.userId) || isAdmin();
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if isOwnProfile(resource.data.userId) || isAdmin();
      allow delete: if false;
    }

    // --- Audit Logs Rules ---
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // --- Activity Logs Rules ---
    match /activityLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // --- Payments Rules ---
    match /payments/{paymentId} {
      allow read: if isOwnProfile(resource.data.userId) || isAdmin();
      allow write: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false;
    }

    // --- Compliance Data Protection ---
    match /complianceLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // --- Sessions Collection ---
    match /sessions/{sessionId} {
      allow read: if isOwnProfile(resource.data.userId) || isAdmin();
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if isOwnProfile(resource.data.userId);
      allow delete: if false;
    }

    // --- Quiz Attempts Rules ---
    match /quizAttempts/{attemptId} {
      allow read: if canViewQuizAttempt(resource.data);
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if isOwnProfile(resource.data.userId);
      allow delete: if false;
    }

    // --- PVQ Records Rules ---
    match /pvqRecords/{recordId} {
      allow read: if isOwnProfile(resource.data.userId) || isAdmin();
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if isOwnProfile(resource.data.userId);
      allow delete: if false;
    }

    // --- Identity Verifications Rules (PVQ) ---
    match /identityVerifications/{verificationId} {
      allow read: if canViewIdentityVerification(resource.data);
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if isOwnProfile(resource.data.userId);
      allow delete: if false;
    }

    // --- Enrollment Records Rules ---
    match /enrollments/{enrollmentId} {
      allow read: if canViewEnrollment(resource.data);
      allow create: if isOwnProfile(request.resource.data.userId) || isAdmin();
      allow update: if canViewEnrollment(resource.data);
      allow delete: if false;
    }

    // --- Progress Records Rules ---
    match /progress/{progressId} {
      allow read: if canViewProgress(resource.data);
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if canViewProgress(resource.data);
      allow delete: if false;
    }

    // --- Video Questions Rules ---
    match /video_post_questions/{questionId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- Video Question Responses Rules ---
    match /video_question_responses/{responseId} {
      allow read: if isOwnProfile(resource.data.userId) || isAdmin();
      allow create: if isOwnProfile(request.resource.data.userId);
      allow update: if isOwnProfile(resource.data.userId);
      allow delete: if false;
    }
  }
}
