import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  createMockFirestore,
  createMockDocumentSnapshot,
  createMockQuerySnapshot,
} from '../../__tests__/mocks';

let mockDb;
let generateEnrollmentCertificate;
let checkEnrollmentCertificateEligibility;
let generateCompletionCertificate;

vi.mock('firebase-admin/firestore', () => ({
  getFirestore: vi.fn(() => mockDb),
}));

vi.mock('firebase-admin', () => ({
  firestore: {
    Timestamp: {
      now: vi.fn(() => ({
        toDate: vi.fn(() => new Date()),
        toMillis: vi.fn(() => Date.now()),
      })),
    },
    FieldValue: {
      serverTimestamp: vi.fn(() => ({ _type: 'server-timestamp' })),
      arrayUnion: vi.fn((val) => ({ _arrayUnion: val })),
    },
  },
}));

vi.mock('firebase-functions', () => ({
  https: {
    HttpsError: class HttpsError extends Error {
      constructor(code, message) {
        super(message);
        this.code = code;
      }
    },
    onCall: vi.fn((fn) => fn),
  },
  logger: {
    log: vi.fn(),
    error: vi.fn(),
  },
}));

describe('Enrollment Certificate Functions', () => {
  let mockContext;

  beforeEach(async () => {
    vi.clearAllMocks();
    mockDb = createMockFirestore();
    
    const certModule = await import('../enrollmentCertificateFunctions');
    generateEnrollmentCertificate = certModule.generateEnrollmentCertificate;
    checkEnrollmentCertificateEligibility = certModule.checkEnrollmentCertificateEligibility;
    generateCompletionCertificate = certModule.generateCompletionCertificate;

    mockContext = {
      auth: { uid: 'user-123' },
      rawRequest: {
        ip: '127.0.0.1',
        headers: { 'user-agent': 'test-agent' }
      }
    };
  });

  describe('generateEnrollmentCertificate', () => {
    it('should throw error if user not authenticated', async () => {
      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateEnrollmentCertificate(data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if userId missing', async () => {
      const data = { courseId: 'course-456', courseName: 'Test Course' };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if courseId missing', async () => {
      const data = { userId: 'user-123', courseName: 'Test Course' };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if courseName missing', async () => {
      const data = { userId: 'user-123', courseId: 'course-456' };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if userId does not match authenticated user', async () => {
      const data = {
        userId: 'different-user',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('permission-denied');
      }
    });

    it('should throw error if user not found', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({}, false)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('not-found');
      }
    });

    it('should throw error if cumulativeMinutes < 120', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              cumulativeMinutes: 100,
              unit1_complete: true,
              unit2_complete: true
            }, true)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('failed-precondition');
      }
    });

    it('should throw error if unit1 not complete', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              cumulativeMinutes: 120,
              unit1_complete: false,
              unit2_complete: true
            }, true)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('failed-precondition');
      }
    });

    it('should throw error if unit2 not complete', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              cumulativeMinutes: 120,
              unit1_complete: true,
              unit2_complete: false
            }, true)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateEnrollmentCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('failed-precondition');
      }
    });
  });

  describe('checkEnrollmentCertificateEligibility', () => {
    it('should throw error if user not authenticated', async () => {
      const data = { userId: 'user-123' };

      try {
        await checkEnrollmentCertificateEligibility(data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if userId missing', async () => {
      try {
        await checkEnrollmentCertificateEligibility({}, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if checking other user eligibility', async () => {
      const data = { userId: 'different-user' };

      try {
        await checkEnrollmentCertificateEligibility(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('permission-denied');
      }
    });

    it('should throw error if user not found', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({}, false)
          )),
        }))
      }));

      const data = { userId: 'user-123' };

      try {
        await checkEnrollmentCertificateEligibility(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('not-found');
      }
    });

    it('should return eligible when all requirements met', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              cumulativeMinutes: 120,
              unit1_complete: true,
              unit2_complete: true,
              enrollmentCertificateGenerated: false
            }, true)
          )),
        }))
      }));

      const data = { userId: 'user-123' };
      const result = await checkEnrollmentCertificateEligibility(data, mockContext);

      expect(result.eligible).toBe(true);
      expect(result.missingRequirements).toHaveLength(0);
    });

    it('should return not eligible when insufficient minutes', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              cumulativeMinutes: 50,
              unit1_complete: true,
              unit2_complete: true,
              enrollmentCertificateGenerated: false
            }, true)
          )),
        }))
      }));

      const data = { userId: 'user-123' };
      const result = await checkEnrollmentCertificateEligibility(data, mockContext);

      expect(result.eligible).toBe(false);
      expect(result.missingRequirements.length).toBeGreaterThan(0);
    });
  });

  describe('generateCompletionCertificate', () => {
    it('should throw error if user not authenticated', async () => {
      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateCompletionCertificate(data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if totalInstructionMinutes < 1440', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              totalInstructionMinutes: 1000,
              finalExamPassed: true,
              finalExamScore: 85
            }, true)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateCompletionCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('failed-precondition');
      }
    });

    it('should throw error if exam not passed', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              totalInstructionMinutes: 1440,
              finalExamPassed: false,
              finalExamScore: 50
            }, true)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateCompletionCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('failed-precondition');
      }
    });

    it('should throw error if exam score < 75', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              displayName: 'John Doe',
              totalInstructionMinutes: 1440,
              finalExamPassed: false,
              finalExamScore: 70
            }, true)
          )),
        }))
      }));

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      try {
        await generateCompletionCertificate(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('failed-precondition');
      }
    });

    it('should return existing completion certificate if already generated', async () => {
      mockDb.collection = vi.fn((collName) => {
        if (collName === 'certificates') {
          return {
            where: vi.fn().mockReturnThis(),
            limit: vi.fn().mockReturnThis(),
            get: vi.fn(() => Promise.resolve(
              createMockQuerySnapshot([
                { id: 'comp-cert-id', data: () => ({ certificateNumber: 'COMP-123' }) }
              ])
            ))
          };
        }
        return {
          doc: vi.fn(() => ({
            get: vi.fn(() => Promise.resolve(
              createMockDocumentSnapshot({
                displayName: 'John Doe',
                totalInstructionMinutes: 1440,
                finalExamPassed: true,
                finalExamScore: 85
              }, true)
            )),
          }))
        };
      });

      const data = {
        userId: 'user-123',
        courseId: 'course-456',
        courseName: 'Test Course'
      };

      const result = await generateCompletionCertificate(data, mockContext);
      expect(result.success).toBe(true);
      expect(result.message).toContain('already generated');
    });
  });
});
