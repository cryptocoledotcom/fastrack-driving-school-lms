import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  createMockFirestore,
  createMockDocumentSnapshot,
  createMockQuerySnapshot,
} from '../../__tests__/mocks';

let mockDb;
let checkVideoQuestionAnswer;
let getVideoQuestion;
let recordVideoQuestionResponse;

vi.mock('firebase-admin', () => ({
  firestore: {
    FieldValue: {
      serverTimestamp: vi.fn(() => ({ _type: 'server-timestamp' })),
    },
  },
}));

vi.mock('firebase-admin/firestore', () => ({
  getFirestore: vi.fn(() => mockDb),
}));

vi.mock('firebase-functions', () => ({
  https: {
    HttpsError: class HttpsError extends Error {
      constructor(code, message) {
        super(message);
        this.code = code;
      }
    },
    onCall: vi.fn((fn) => fn),
  },
  logger: {
    log: vi.fn(),
    error: vi.fn(),
  },
}));

const mockFirebaseAdmin = {
  firestore: {
    FieldValue: {
      serverTimestamp: vi.fn(() => ({ _type: 'server-timestamp' })),
    },
  },
};

vi.stubGlobal('admin', mockFirebaseAdmin);

describe('Video Question Functions', () => {
  let mockContext;
  let mockDb_original;

  beforeEach(async () => {
    vi.clearAllMocks();
    mockDb = createMockFirestore();
    
    const videoModule = await import('../videoQuestionFunctions');
    checkVideoQuestionAnswer = videoModule.checkVideoQuestionAnswer;
    getVideoQuestion = videoModule.getVideoQuestion;
    recordVideoQuestionResponse = videoModule.recordVideoQuestionResponse;

    mockContext = {
      auth: { uid: 'user-123' },
      rawRequest: {
        ip: '127.0.0.1',
        headers: { 'user-agent': 'test-agent' }
      }
    };
  });

  describe('checkVideoQuestionAnswer', () => {
    it('should throw error if user not authenticated', async () => {
      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if userId missing', async () => {
      const data = {
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if lessonId missing', async () => {
      const data = {
        userId: 'user-123',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if courseId missing', async () => {
      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if questionId missing', async () => {
      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if selectedAnswer missing', async () => {
      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if userId does not match auth user', async () => {
      const data = {
        userId: 'different-user',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('permission-denied');
      }
    });

    it('should throw error if question not found', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({}, false)
          ))
        }))
      }));

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      try {
        await checkVideoQuestionAnswer(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('not-found');
      }
    });

    it('should return correct answer if selection is correct', async () => {
      mockDb.collection = vi.fn((collName) => {
        if (collName === 'video_post_questions') {
          return {
            doc: vi.fn(() => ({
              get: vi.fn(() => Promise.resolve(
                createMockDocumentSnapshot({
                  correctAnswer: 'A',
                  question: 'What is 2+2?',
                  explanation: 'The sum of 2 and 2 is 4',
                  answers: ['4', '5', '6']
                }, true)
              ))
            }))
          };
        }
        return {
          add: vi.fn(() => Promise.resolve())
        };
      });

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A'
      };

      const result = await checkVideoQuestionAnswer(data, mockContext);
      expect(result.isCorrect).toBe(true);
      expect(result.correctAnswer).toBeNull();
    });

    it('should return correct answer if selection is incorrect', async () => {
      mockDb.collection = vi.fn((collName) => {
        if (collName === 'video_post_questions') {
          return {
            doc: vi.fn(() => ({
              get: vi.fn(() => Promise.resolve(
                createMockDocumentSnapshot({
                  correctAnswer: 'A',
                  question: 'What is 2+2?',
                  explanation: 'The sum of 2 and 2 is 4',
                  answers: ['4', '5', '6']
                }, true)
              ))
            }))
          };
        }
        return {
          add: vi.fn(() => Promise.resolve())
        };
      });

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'B'
      };

      const result = await checkVideoQuestionAnswer(data, mockContext);
      expect(result.isCorrect).toBe(false);
      expect(result.correctAnswer).toBe('A');
    });

    it('should include explanation in response', async () => {
      mockDb.collection = vi.fn((collName) => {
        if (collName === 'video_post_questions') {
          return {
            doc: vi.fn(() => ({
              get: vi.fn(() => Promise.resolve(
                createMockDocumentSnapshot({
                  correctAnswer: 'A',
                  question: 'What is 2+2?',
                  explanation: 'The sum of 2 and 2 is 4',
                  answers: ['4', '5', '6']
                }, true)
              ))
            }))
          };
        }
        return {
          add: vi.fn(() => Promise.resolve())
        };
      });

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'B'
      };

      const result = await checkVideoQuestionAnswer(data, mockContext);
      expect(result.explanation).toBe('The sum of 2 and 2 is 4');
    });
  });

  describe('getVideoQuestion', () => {
    it('should throw error if user not authenticated', async () => {
      const data = { lessonId: 'lesson-456' };

      try {
        await getVideoQuestion(data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if lessonId missing', async () => {
      try {
        await getVideoQuestion({}, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should return null if no active questions found', async () => {
      mockDb.collection = vi.fn(() => ({
        where: vi.fn().mockReturnThis(),
        limit: vi.fn().mockReturnThis(),
        get: vi.fn(() => Promise.resolve(createMockQuerySnapshot([])))
      }));

      const data = { lessonId: 'lesson-456' };
      const result = await getVideoQuestion(data, mockContext);
      expect(result.question).toBeNull();
    });

    it('should return video question data', async () => {
      mockDb.collection = vi.fn(() => ({
        where: vi.fn().mockReturnThis(),
        limit: vi.fn().mockReturnThis(),
        get: vi.fn(() => Promise.resolve(
          createMockQuerySnapshot([
            {
              id: 'question-101',
              data: () => ({
                question: 'What is 2+2?',
                answers: ['4', '5', '6'],
                explanation: 'Basic arithmetic'
              })
            }
          ])
        ))
      }));

      const data = { lessonId: 'lesson-456' };
      const result = await getVideoQuestion(data, mockContext);
      expect(result.id).toBe('question-101');
      expect(result.question).toBe('What is 2+2?');
      expect(result.answers.length).toBe(3);
    });

    it('should not include explanation in response', async () => {
      mockDb.collection = vi.fn(() => ({
        where: vi.fn().mockReturnThis(),
        limit: vi.fn().mockReturnThis(),
        get: vi.fn(() => Promise.resolve(
          createMockQuerySnapshot([
            {
              id: 'question-101',
              data: () => ({
                question: 'What is 2+2?',
                answers: ['4', '5', '6'],
                explanation: 'Basic arithmetic'
              })
            }
          ])
        ))
      }));

      const data = { lessonId: 'lesson-456' };
      const result = await getVideoQuestion(data, mockContext);
      expect(result.explanation).toBeUndefined();
    });
  });

  describe('recordVideoQuestionResponse', () => {
    it('should throw error if user not authenticated', async () => {
      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A',
        isCorrect: true
      };

      try {
        await recordVideoQuestionResponse(data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if userId missing', async () => {
      const data = {
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A',
        isCorrect: true
      };

      try {
        await recordVideoQuestionResponse(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if userId does not match auth user', async () => {
      const data = {
        userId: 'different-user',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A',
        isCorrect: true
      };

      try {
        await recordVideoQuestionResponse(data, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('permission-denied');
      }
    });

    it('should record response successfully', async () => {
      mockDb.collection = vi.fn(() => ({
        add: vi.fn(() => Promise.resolve({ id: 'response-123' }))
      }));

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A',
        isCorrect: true
      };

      const result = await recordVideoQuestionResponse(data, mockContext);
      expect(result.id).toBe('response-123');
      expect(result.recorded).toBe(true);
    });

    it('should include isCorrect in response data', async () => {
      const addMock = vi.fn(() => Promise.resolve({ id: 'response-123' }));
      mockDb.collection = vi.fn(() => ({
        add: addMock
      }));

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A',
        isCorrect: false
      };

      await recordVideoQuestionResponse(data, mockContext);
      const collectionAddCall = addMock.mock.calls[0][0];
      expect(collectionAddCall.isCorrect).toBe(false);
    });

    it('should include timestamp in recorded response', async () => {
      const addMock = vi.fn(() => Promise.resolve({ id: 'response-123' }));
      mockDb.collection = vi.fn(() => ({
        add: addMock
      }));

      const data = {
        userId: 'user-123',
        lessonId: 'lesson-456',
        courseId: 'course-789',
        questionId: 'question-101',
        selectedAnswer: 'A',
        isCorrect: true
      };

      await recordVideoQuestionResponse(data, mockContext);
      const collectionAddCall = addMock.mock.calls[0][0];
      expect(collectionAddCall.respondedAt).toBeDefined();
    });
  });
});
