import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  createMockFirestore,
  createMockDocumentSnapshot,
  createMockQuerySnapshot,
} from '../../__tests__/mocks';

let mockDb;
let validateDETSRecord;
let exportDETSReport;
let submitDETSToState;
let getDETSReports;
let processPendingDETSReports;

vi.mock('firebase-admin/firestore', () => ({
  getFirestore: vi.fn(() => mockDb),
}));

vi.mock('firebase-admin', () => ({
  firestore: {
    Timestamp: {
      now: vi.fn(() => ({
        toDate: vi.fn(() => new Date()),
        toMillis: vi.fn(() => Date.now()),
      })),
    },
    FieldValue: {
      serverTimestamp: vi.fn(() => ({ _type: 'server-timestamp' })),
      increment: vi.fn((val) => ({ _increment: val })),
    },
  },
}));

vi.mock('firebase-functions', () => ({
  https: {
    HttpsError: class HttpsError extends Error {
      constructor(code, message) {
        super(message);
        this.code = code;
      }
    },
    onCall: vi.fn((fn) => fn),
  },
  logger: {
    log: vi.fn(),
    error: vi.fn(),
    warn: vi.fn(),
  },
}));

vi.mock('../../common/auditLogger', () => ({
  logAuditEvent: vi.fn(() => Promise.resolve()),
}));

describe('DETS Integration Functions', () => {
  let mockRequest;
  let mockContext;

  beforeEach(async () => {
    vi.clearAllMocks();
    mockDb = createMockFirestore();
    
    const detsModule = await import('../detsFunctions');
    validateDETSRecord = detsModule.validateDETSRecord;
    exportDETSReport = detsModule.exportDETSReport;
    submitDETSToState = detsModule.submitDETSToState;
    getDETSReports = detsModule.getDETSReports;
    processPendingDETSReports = detsModule.processPendingDETSReports;

    mockContext = {
      auth: { uid: 'user-123' },
      rawRequest: {
        ip: '127.0.0.1',
        headers: { 'user-agent': 'test-agent' }
      }
    };

    mockRequest = { data: {}, auth: mockContext.auth };
  });

  describe('validateDETSRecord', () => {
    it('should validate required fields', async () => {
      const record = {
        studentId: 'student-123',
        firstName: 'John',
        lastName: 'Doe',
        dateOfBirth: '2000-01-15',
        driverLicense: 'OH123456'
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(true);
      expect(result.errors).toHaveLength(0);
    });

    it('should error if studentId missing', async () => {
      const record = {
        firstName: 'John',
        lastName: 'Doe'
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
      expect(result.errors.length).toBeGreaterThan(0);
    });

    it('should error if firstName missing', async () => {
      const record = {
        studentId: 'student-123',
        lastName: 'Doe'
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
    });

    it('should error if lastName missing', async () => {
      const record = {
        studentId: 'student-123',
        firstName: 'John'
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
    });

    it('should error if dateOfBirth invalid format', async () => {
      const record = {
        studentId: 'student-123',
        firstName: 'John',
        lastName: 'Doe',
        dateOfBirth: 'invalid-date'
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
    });

    it('should error if driverLicense invalid format', async () => {
      const record = {
        studentId: 'student-123',
        firstName: 'John',
        lastName: 'Doe',
        driverLicense: 'INVALID'
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
    });

    it('should error if examScore out of range', async () => {
      const record = {
        studentId: 'student-123',
        firstName: 'John',
        lastName: 'Doe',
        examScore: 150
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
    });

    it('should error if totalInstructionMinutes < 1440', async () => {
      const record = {
        studentId: 'student-123',
        firstName: 'John',
        lastName: 'Doe',
        totalInstructionMinutes: 1000
      };

      const result = await validateDETSRecord(record, mockContext);
      expect(result.isValid).toBe(false);
    });
  });

  describe('exportDETSReport', () => {
    it('should throw error if user not authenticated', async () => {
      const request = {
        data: { courseId: 'course-456' },
        auth: null
      };

      try {
        await exportDETSReport(request.data, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if courseId missing', async () => {
      const request = {
        data: {},
        auth: mockContext.auth
      };

      try {
        await exportDETSReport({}, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });

    it('should throw error if no eligible records found', async () => {
      mockDb.collection = vi.fn(() => ({
        where: vi.fn().mockReturnThis(),
        get: vi.fn(() => Promise.resolve(createMockQuerySnapshot([]))),
        doc: vi.fn(),
        add: vi.fn(),
      }));

      try {
        await exportDETSReport({ courseId: 'course-456' }, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('not-found');
      }
    });
  });

  describe('submitDETSToState', () => {
    it('should throw error if user not authenticated', async () => {
      try {
        await submitDETSToState({ reportId: 'report-123' }, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should throw error if reportId missing', async () => {
      try {
        await submitDETSToState({}, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('invalid-argument');
      }
    });
  });

  describe('getDETSReports', () => {
    it('should throw error if user not authenticated', async () => {
      try {
        await getDETSReports({}, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('unauthenticated');
      }
    });

    it('should retrieve reports with default pagination', async () => {
      mockDb.collection = vi.fn(() => ({
        orderBy: vi.fn().mockReturnThis(),
        limit: vi.fn().mockReturnThis(),
        offset: vi.fn().mockReturnThis(),
        get: vi.fn(() => Promise.resolve(
          createMockQuerySnapshot([
            { id: 'report-1', data: () => ({ status: 'ready', recordCount: 10 }) }
          ])
        )),
        count: vi.fn().mockReturnValue({
          get: vi.fn(() => Promise.resolve({ data: () => ({ count: 1 }) }))
        }),
      }));

      const result = await getDETSReports({}, mockContext);
      expect(result.reports).toBeDefined();
      expect(Array.isArray(result.reports)).toBe(true);
    });

    it('should retrieve specific report by reportId', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({ id: 'report-123', status: 'ready' }, true)
          ))
        }))
      }));

      const result = await getDETSReports({ reportId: 'report-123' }, mockContext);
      expect(result.report).toBeDefined();
    });

    it('should throw error if specific report not found', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({}, false)
          ))
        }))
      }));

      try {
        await getDETSReports({ reportId: 'nonexistent' }, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('not-found');
      }
    });
  });

  describe('processPendingDETSReports', () => {
    it('should throw error if user not authenticated', async () => {
      try {
        await processPendingDETSReports({}, { auth: null });
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('authentication-required');
      }
    });

    it('should throw error if user is not admin', async () => {
      mockDb.collection = vi.fn(() => ({
        doc: vi.fn(() => ({
          get: vi.fn(() => Promise.resolve(
            createMockDocumentSnapshot({
              uid: 'user-123',
              role: 'student'
            }, true)
          ))
        }))
      }));

      try {
        await processPendingDETSReports({}, mockContext);
        expect(true).toBe(false);
      } catch (error) {
        expect(error.code).toBe('permission-denied');
      }
    });

    it('should process pending reports when user is SUPER_ADMIN', async () => {
      mockDb.collection = vi.fn((collName) => {
        if (collName === 'users') {
          return {
            doc: vi.fn(() => ({
              get: vi.fn(() => Promise.resolve(
                createMockDocumentSnapshot({
                  uid: 'user-123',
                  role: 'SUPER_ADMIN'
                }, true)
              ))
            }))
          };
        }
        return {
          where: vi.fn().mockReturnThis(),
          limit: vi.fn().mockReturnThis(),
          get: vi.fn(() => Promise.resolve(createMockQuerySnapshot([]))),
        };
      });

      const result = await processPendingDETSReports({}, mockContext);
      expect(result.success).toBe(true);
    });

    it('should process pending reports when user is DMV_ADMIN', async () => {
      mockDb.collection = vi.fn((collName) => {
        if (collName === 'users') {
          return {
            doc: vi.fn(() => ({
              get: vi.fn(() => Promise.resolve(
                createMockDocumentSnapshot({
                  uid: 'user-123',
                  role: 'DMV_ADMIN'
                }, true)
              ))
            }))
          };
        }
        return {
          where: vi.fn().mockReturnThis(),
          limit: vi.fn().mockReturnThis(),
          get: vi.fn(() => Promise.resolve(createMockQuerySnapshot([]))),
        };
      });

      const result = await processPendingDETSReports({}, mockContext);
      expect(result.success).toBe(true);
    });
  });
});
